<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Avaliacao</title>
  <link rel="stylesheet" href="/static/css/admin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="admin-page">
  <header class="admin-header">
    <div>
      <h1>Painel Administrativo</h1>
      <p>An?lise de satisfa??o</p>
    </div>
    <div class="admin-actions">
      <a class="btn-outline" href="/admin_2026/logout">Sair</a>
    </div>
  </header>

  <main class="admin-container">
    <section class="cards">
      <div class="card">
        <h3>Total Hoje ({{ day }})</h3>
        <p class="big">{{ stats.total }}</p>
      </div>
      <div class="card">
        <h3>Muito Satisfeito</h3>
        <p class="big">{{ stats.muito }}</p>
        <span class="muted">{{ stats.pct_muito }}%</span>
      </div>
      <div class="card">
        <h3>Satisfeito</h3>
        <p class="big">{{ stats.satis }}</p>
        <span class="muted">{{ stats.pct_satis }}%</span>
      </div>
      <div class="card">
        <h3>Insatisfeito</h3>
        <p class="big">{{ stats.insatis }}</p>
        <span class="muted">{{ stats.pct_insatis }}%</span>
      </div>
    </section>

    <section class="filters">
      <form method="GET" class="filter-box">
        <label>Filtrar por dia</label>
        <input type="date" name="day" value="{{ day }}">
        <button type="submit">Aplicar</button>
        <a class="btn-outline" href="/admin_2026?day={{ today }}">Hoje</a>
      </form>
      <form method="GET" class="filter-box">
        <label>Comparar dias</label>
        <input type="date" name="compare_a" value="{{ compare_data.a if compare_data }}">
        <input type="date" name="compare_b" value="{{ compare_data.b if compare_data }}">
        <button type="submit">Comparar</button>
      </form>
    </section>

    <section class="charts">
      <div class="chart-card">
        <h3>Gr?fico de Barras</h3>
        <canvas id="barChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Gr?fico Circular</h3>
        <canvas id="pieChart"></canvas>
      </div>
    </section>

    <section class="charts">
      <div class="chart-card full">
        <h3>An?lise Temporal (?ltimos 7 dias)</h3>
        <canvas id="lineChart"></canvas>
      </div>
    </section>

    {% if compare_data %}
    <section class="compare">
      <h3>Compara??o entre dias</h3>
      <div class="compare-grid">
        <div class="compare-card">
          <h4>{{ compare_data.a }}</h4>
          <p>Muito: {{ compare_data.a_stats.muito }}</p>
          <p>Satisfeito: {{ compare_data.a_stats.satis }}</p>
          <p>Insatisfeito: {{ compare_data.a_stats.insatis }}</p>
        </div>
        <div class="compare-card">
          <h4>{{ compare_data.b }}</h4>
          <p>Muito: {{ compare_data.b_stats.muito }}</p>
          <p>Satisfeito: {{ compare_data.b_stats.satis }}</p>
          <p>Insatisfeito: {{ compare_data.b_stats.insatis }}</p>
        </div>
      </div>
    </section>
    {% endif %}

    <section class="table-section">
      <div class="table-header">
        <h3>Registos do Dia ({{ day }})</h3>
        <div class="export">
          <form method="GET" action="/admin_2026/export" class="export-form">
            <input type="date" name="start" value="{{ day }}">
            <input type="date" name="end" value="{{ day }}">
            <button name="format" value="csv" type="submit">Exportar CSV</button>
            <button name="format" value="txt" type="submit" class="btn-outline">Exportar TXT</button>
          </form>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Grau</th>
            <th>Data</th>
            <th>Hora</th>
            <th>Dia Semana</th>
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.grau_satisfacao }}</td>
            <td>{{ r.data }}</td>
            <td>{{ r.hora }}</td>
            <td>{{ r.dia_semana }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination">
        {% if page > 1 %}
          <a href="/admin_2026?day={{ day }}&page={{ page - 1 }}&limit={{ limit }}">Anterior</a>
        {% endif %}
        <span>P?gina {{ page }}</span>
        {% if total_records > page * limit %}
          <a href="/admin_2026?day={{ day }}&page={{ page + 1 }}&limit={{ limit }}">Pr?xima</a>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    const stats = {{ stats | tojson }};
    const labels = {{ labels | tojson }};
    const values = {{ values | tojson }};

    const barCtx = document.getElementById('barChart');
    new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ['Muito satisfeito', 'Satisfeito', 'Insatisfeito'],
        datasets: [{
          data: [stats.muito, stats.satis, stats.insatis],
          backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    const pieCtx = document.getElementById('pieChart');
    new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: ['Muito satisfeito', 'Satisfeito', 'Insatisfeito'],
        datasets: [{
          data: [stats.muito, stats.satis, stats.insatis],
          backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
        }]
      },
      options: { responsive: true }
    });

    const lineCtx = document.getElementById('lineChart');
    new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Total por dia',
          data: values,
          borderColor: '#4f46e5',
          backgroundColor: 'rgba(79, 70, 229, 0.15)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });
  </script>
</body>
</html>
